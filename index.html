<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shh Chat</title>
    <style>
        /* General Styles */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Inter', Arial, sans-serif;
        }
        body {
            background: #f0f2f5; /* Lighter background */
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            color: #333;
            line-height: 1.6;
        }
        .container {
            width: 100%;
            max-width: 420px; /* Slightly wider */
            background-color: white;
            border-radius: 12px; /* More rounded */
            box-shadow: 0 8px 24px rgba(0,0,0,0.1); /* Softer shadow */
            overflow: hidden; /* Ensures child elements conform to border radius */
            display: flex; /* Added to manage children layout */
            flex-direction: column; /* Added */
            height: clamp(400px, 90vh, 700px); /* Added: Responsive height for the container */
        }

        /* Welcome Screen */
        .welcome-card {
            padding: 30px 25px; /* More padding */
            text-align: center;
            flex-grow: 1; /* Added to allow it to take space if chat is hidden */
            display: flex; /* Added */
            flex-direction: column; /* Added */
            justify-content: center; /* Added */
        }
        .welcome-title {
            font-size: 2rem; /* Larger title */
            color: #1a73e8; /* Primary color */
            margin-bottom: 10px;
            font-weight: 600;
        }
        .welcome-subtitle {
            color: #5f6368; /* Subtler subtitle color */
            font-size: 1rem;
            margin-bottom: 30px;
        }
        .form-group {
            margin-bottom: 20px;
            text-align: left;
        }
        .form-label {
            font-size: 0.9rem;
            color: #3c4043;
            margin-bottom: 8px;
            display: block;
            font-weight: 500;
        }
        .form-input {
            width: 100%;
            padding: 12px 15px; /* More padding */
            border: 1px solid #dadce0; /* Lighter border */
            border-radius: 8px; /* More rounded */
            font-size: 1rem;
            transition: border-color 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        }
        .form-input:focus {
            outline: none;
            border-color: #1a73e8;
            box-shadow: 0 0 0 2px rgba(26, 115, 232, 0.2); /* Focus ring */
        }
        .join-btn {
            width: 100%;
            padding: 12px 15px;
            background: #1a73e8; /* Primary color */
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s ease-in-out;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        .join-btn:hover {
            background: #1765cc; /* Darker shade on hover */
        }
        .join-btn:disabled {
            background: #e0e0e0;
            cursor: not-allowed;
        }

        /* Chat Interface */
        .chat-container {
            display: none; /* Initially hidden */
            flex-direction: column;
            /* height: 600px; /* Taller chat - REMOVED, parent .container now controls height */
            /* max-width: 420px; /* REMOVED, inherited from .container */
            width: 100%;
            flex-grow: 1; /* Added to take available space in .container */
            overflow: hidden; /* Added to ensure children are contained */
        }
        .chat-header {
            background: #1a73e8;
            color: white;
            padding: 15px 20px; /* More padding */
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #1765cc; /* Subtle border */
            position: sticky; /* <<< MODIFIED */
            top: 0;           /* <<< ADDED */
            z-index: 10;      /* <<< ADDED */
            width: 100%;      /* <<< ADDED */
        }
        .room-info h3 {
            font-size: 1.1rem;
            font-weight: 600;
        }
        .online-count {
            font-size: 0.85rem;
            display: flex;
            align-items: center;
            gap: 6px;
            opacity: 0.9;
        }
        .online-dot {
            width: 8px;
            height: 8px;
            background: #34a853; /* Green dot */
            border-radius: 50%;
        }
        .chat-actions {
            display: flex;
            gap: 10px;
        }
        .action-btn {
            width: 36px;
            height: 36px;
            border: none;
            background: rgba(255,255,255,0.15); /* More subtle */
            color: white;
            border-radius: 8px; /* More rounded */
            cursor: pointer;
            font-size: 1.1rem; /* Larger icons */
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background-color 0.2s ease-in-out;
        }
        .action-btn:hover {
            background: rgba(255,255,255,0.25);
        }
        .messages-container {
            flex: 1; /*MODIFIED*/
            padding: 15px;
            overflow-y: auto; /* This is where the scrolling happens */
            display: flex;
            flex-direction: column;
            gap: 12px; /* More space between messages */
            background-color: #f8f9fa; /* Light background for messages area */
        }
        .message {
            display: flex;
            flex-direction: column;
            max-width: 85%; /* Slightly wider messages */
        }
        .message.own {
            align-self: flex-end;
        }
        .message.other {
            align-self: flex-start;
        }
        .message-bubble {
            padding: 10px 15px; /* More padding */
            border-radius: 18px; /* Bubble shape */
            font-size: 0.95rem;
            line-height: 1.5;
            word-wrap: break-word;
        }
        .message.own .message-bubble {
            background: #1a73e8;
            color: white;
            border-bottom-right-radius: 4px; /* Tail effect */
        }
        .message.other .message-bubble {
            background: #e9ebee; /* Lighter grey for other messages */
            color: #202124; /* Darker text for readability */
            border-bottom-left-radius: 4px; /* Tail effect */
        }
        .message-info {
            font-size: 0.75rem; /* Smaller info text */
            color: #5f6368;
            margin-bottom: 4px; /* Space between info and bubble */
            padding: 0 5px;
        }
        .message.own .message-info {
            text-align: right;
        }
        .message.other .message-info {
            text-align: left;
        }
        .message-input-container {
            padding: 15px;
            display: flex;
            gap: 10px;
            border-top: 1px solid #dadce0; /* Clearer separator */
            background-color: #fff;
            position: sticky; /* <<< MODIFIED */
            bottom: 0;        /* <<< ADDED */
            z-index: 10;      /* <<< ADDED */
            width: 100%;      /* <<< ADDED */
        }
        .message-input {
            flex: 1;
            padding: 12px 15px;
            border: 1px solid #dadce0;
            border-radius: 20px; /* Pill shape */
            font-size: 0.95rem;
        }
        .message-input:focus {
            outline: none;
            border-color: #1a73e8;
            box-shadow: 0 0 0 2px rgba(26, 115, 232, 0.2);
        }
        .send-btn {
            width: 44px; /* Larger send button */
            height: 44px;
            border: none;
            background: #1a73e8;
            color: white;
            border-radius: 50%; /* Circular button */
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem; /* Larger send icon */
            transition: background-color 0.2s ease-in-out;
        }
        .send-btn:hover {
            background: #1765cc;
        }
        .send-btn:disabled {
            background-color: #e0e0e0;
            cursor: not-allowed;
        }
        .system-message {
            text-align: center;
            color: #5f6368;
            font-size: 0.85rem;
            padding: 8px 0;
            font-style: italic;
        }
        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 5px;
            height: 20px; /* Ensure it has height for alignment */
        }
        .loading-dot {
            width: 8px;
            height: 8px;
            background: white; /* Dots are white on blue button */
            border-radius: 50%;
            animation: loadingPulse 1.4s infinite ease-in-out;
        }
        .loading-dot:nth-child(1) { animation-delay: -0.32s; }
        .loading-dot:nth-child(2) { animation-delay: -0.16s; }
        @keyframes loadingPulse {
            0%, 80%, 100% { transform: scale(0); }
            40% { transform: scale(1.0); }
        }

        /* Modal Styles */
        .modal-backdrop {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            display: none; /* Hidden by default */
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .modal-content {
            background-color: white;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            width: 90%;
            max-width: 350px;
            text-align: center;
        }
        .modal-message {
            font-size: 1rem;
            color: #333;
            margin-bottom: 20px;
        }
        .modal-buttons {
            display: flex;
            justify-content: center;
            gap: 10px;
        }
        .modal-button {
            padding: 10px 20px;
            border-radius: 6px;
            border: none;
            font-size: 0.9rem;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.2s, color 0.2s;
        }
        .modal-button.confirm {
            background-color: #1a73e8;
            color: white;
        }
        .modal-button.confirm:hover {
            background-color: #1765cc;
        }
        .modal-button.cancel {
            background-color: #e0e0e0;
            color: #333;
        }
        .modal-button.cancel:hover {
            background-color: #d5d5d5;
        }

        @media (max-width: 480px) {
            .container {
                margin: 0;
                border-radius: 0;
                height: 100vh; /* Ensure it takes full viewport height */
                box-shadow: none;
            }
            .chat-container {
                height: 100%; /* Full height on mobile */
                border-radius: 0;
            }
            .messages-container {
                padding: 10px;
            }
            .message-input-container {
                padding: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="welcome-card" id="welcomeScreen">
            <h1 class="welcome-title">Shh Chat</h1>
            <p class="welcome-subtitle">Join or create a temporary chat room</p>
            <form id="joinForm">
                <div class="form-group">
                    <label class="form-label" for="displayName">Your Name</label>
                    <input type="text" class="form-input" id="displayName" placeholder="Enter your name" required>
                </div>
                <div class="form-group">
                    <label class="form-label" for="roomCode">Room Code (optional)</label>
                    <input type="text" class="form-input" id="roomCode" placeholder="Enter code or leave blank to create">
                </div>
                <button type="submit" class="join-btn" id="joinBtn">
                    Join Chat
                </button>
            </form>
        </div>

        <div class="chat-container" id="chatContainer">
            <div class="chat-header">
                <div class="room-info">
                    <h3 id="roomTitle">Room</h3>
                    <div class="online-count">
                        <div class="online-dot"></div>
                        <span id="onlineCount">0 online</span>
                    </div>
                </div>
                <div class="chat-actions">
                    <button class="action-btn" id="shareRoomBtn" title="Share Room">↗</button>
                    <button class="action-btn" id="leaveRoomBtn" title="Leave Room">×</button>
                </div>
            </div>
            <div class="messages-container" id="messagesContainer">
                </div>
            <div class="message-input-container">
                <input type="text" class="message-input" id="messageInput" placeholder="Type a message..." maxlength="500">
                <button class="send-btn" id="sendBtn" title="Send Message">→</button>
            </div>
        </div>
    </div>

    <div class="modal-backdrop" id="customModal">
        <div class="modal-content">
            <p class="modal-message" id="modalMessageText"></p>
            <div class="modal-buttons">
                <button class="modal-button confirm" id="modalConfirmBtn">OK</button>
                <button class="modal-button cancel" id="modalCancelBtn">Cancel</button>
            </div>
        </div>
    </div>


    <script type="module">
        // Import Firebase modules
        // Make sure you are using a recent version of Firebase SDK. 9.6.0 is a bit old.
        // Consider updating to a more recent v9 or v10. E.g., 9.15.0 or latest.
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.0/firebase-app.js";
        import { 
            getDatabase, 
            ref, 
            set, 
            push, 
            get, 
            onChildAdded, 
            onValue,
            remove,
            serverTimestamp // For more accurate timestamps
        } from "https://www.gstatic.com/firebasejs/9.6.0/firebase-database.js";

        // --- DOM Element Declarations (Moved Up) ---
        const welcomeScreen = document.getElementById('welcomeScreen');
        const chatContainer = document.getElementById('chatContainer');
        const joinForm = document.getElementById('joinForm');
        const displayNameInput = document.getElementById('displayName');
        const roomCodeInput = document.getElementById('roomCode');
        const roomTitle = document.getElementById('roomTitle');
        const onlineCountEl = document.getElementById('onlineCount');
        const messagesContainer = document.getElementById('messagesContainer');
        const messageInput = document.getElementById('messageInput');
        const sendBtn = document.getElementById('sendBtn');
        const shareRoomBtn = document.getElementById('shareRoomBtn');
        const leaveRoomBtn = document.getElementById('leaveRoomBtn');
        const joinBtn = document.getElementById('joinBtn');

        // Modal Elements (Moved Up)
        const customModal = document.getElementById('customModal');
        const modalMessageText = document.getElementById('modalMessageText');
        const modalConfirmBtn = document.getElementById('modalConfirmBtn');
        const modalCancelBtn = document.getElementById('modalCancelBtn');
        let modalConfirmCallback = null;


        // --- Modal Functions (Moved Up) ---
        // It's good practice to define functions before they are called,
        // especially if one might be called during an early initialization error.
        function showCustomAlert(message) {
            if (modalMessageText && customModal && modalConfirmBtn && modalCancelBtn) {
                modalMessageText.textContent = message;
                modalConfirmBtn.style.display = 'inline-block';
                modalCancelBtn.style.display = 'none';
                customModal.style.display = 'flex';
                return new Promise((resolve) => {
                    modalConfirmCallback = () => {
                        customModal.style.display = 'none';
                        resolve(true);
                    };
                });
            } else {
                // Fallback if modal elements are not yet ready (should not happen with current order)
                console.error("Modal elements not ready for alert:", message);
                alert(message); // Basic fallback
                return Promise.resolve(true);
            }
        }

        function showCustomConfirm(message) {
            if (modalMessageText && customModal && modalConfirmBtn && modalCancelBtn) {
                modalMessageText.textContent = message;
                modalConfirmBtn.style.display = 'inline-block';
                modalCancelBtn.style.display = 'inline-block';
                customModal.style.display = 'flex';
                return new Promise((resolve) => {
                    modalConfirmCallback = (confirmed) => {
                        customModal.style.display = 'none';
                        resolve(confirmed);
                    };
                });
            } else {
                // Fallback
                console.error("Modal elements not ready for confirm:", message);
                return Promise.resolve(window.confirm(message)); // Basic fallback
            }
        }
        
        // Attach listeners to modal buttons now that they are defined
        if (modalConfirmBtn) {
            modalConfirmBtn.addEventListener('click', () => {
                if (modalConfirmCallback) modalConfirmCallback(true);
            });
        }
        if (modalCancelBtn) {
            modalCancelBtn.addEventListener('click', () => {
                if (modalConfirmCallback) modalConfirmCallback(false);
            });
        }


        // --- Firebase Configuration and Initialization ---
        // CRITICAL: Replace ALL placeholder values below with your actual Firebase project configuration.
        // The databaseURL MUST be in the format: https://<YOUR-PROJECT-ID>-default-rtdb.firebaseio.com (or your specific region if not us-central1)
        const firebaseConfig = {
            apiKey: "AIzaSyBAXWKvlpwnzI9Lghj81d1_M1pIRbuM200",
            authDomain: "shh-chat-db9d0.firebaseapp.com",
            databaseURL: "https://shh-chat-db9d0-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "shh-chat-db9d0",
            storageBucket: "shh-chat-db9d0.firebasestorage.app",
            messagingSenderId: "20040883450",
            appId: "1:20040883450:web:833660405c634b2aaffd43"
        };
        
        let app;
        let database;

        try {
            app = initializeApp(firebaseConfig);
            database = getDatabase(app);
            console.log("Firebase initialized successfully.");
        } catch (error) {
            console.error("Firebase initialization error:", error);
            // showCustomAlert is now defined and its elements are also defined.
            showCustomAlert(`Firebase initialization error. Please check your configuration and the console. Error: ${error.message}`);
            if (joinBtn) { // Check if joinBtn exists before trying to disable
                joinBtn.disabled = true;
                joinBtn.textContent = 'Firebase Error';
            }
        }

        // In-memory state for chat data
        const chatData = {
            currentUser: null,
            currentRoom: null,
            messageListeners: [] // To store unsubscribe functions for listeners
        };

        // --- Utility functions ---
        function generateRoomCode() {
            return Math.random().toString(36).substring(2, 8).toUpperCase();
        }

        function generateUserId() {
            return self.crypto?.randomUUID ? self.crypto.randomUUID() : Math.random().toString(36).substring(2, 15) + Math.random().toString(36).substring(2,15) ;
        }

        function formatTime(timestamp) {
            if (!timestamp) return '';
            return new Date(timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // --- Firebase operations ---
        async function createOrJoinRoom(roomCode, userName) {
            if (!database) {
                 showCustomAlert("Database not initialized. Cannot join room.");
                 return null;
            }
            const userId = generateUserId();
            const user = {
                id: userId,
                name: userName,
                joinedAt: serverTimestamp(),
                lastSeen: serverTimestamp()
            };

            chatData.currentUser = user;

            const effectiveRoomCode = roomCode || generateRoomCode();
            const roomRefPath = 'rooms/' + effectiveRoomCode;
            const roomRef = ref(database, roomRefPath);
            
            try {
                const snapshot = await get(roomRef);
                if (!snapshot.exists()) {
                    await set(roomRef, {
                        code: effectiveRoomCode,
                        createdAt: serverTimestamp(),
                        users: { [userId]: {name: userName, joinedAt: serverTimestamp()} } 
                    });
                } else {
                    await set(ref(database, `${roomRefPath}/users/${userId}`), {name: userName, joinedAt: serverTimestamp()});
                }
                chatData.currentRoom = effectiveRoomCode;
                addSystemMessage(`${userName} joined the chat.`);
                return { roomCode: effectiveRoomCode, userId };

            } catch (error) {
                console.error("Error creating/joining room:", error);
                showCustomAlert(`Error joining room: ${error.message}`);
                return null;
            }
        }
        
        async function addSystemMessage(text) {
            if (!chatData.currentRoom || !database) return;
            const message = {
                id: generateUserId(),
                type: 'system',
                text: text,
                timestamp: serverTimestamp()
            };
            const messagesRef = ref(database, `rooms/${chatData.currentRoom}/messages`);
            try {
                await push(messagesRef, message);
            } catch (error) {
                console.error("Error sending system message:", error);
            }
        }

        async function sendMessage() {
            if (!database) return;
            const text = messageInput.value.trim();
            if (!text || !chatData.currentUser || !chatData.currentRoom) return;

            const message = {
                id: generateUserId(),
                type: 'user',
                text: text,
                userId: chatData.currentUser.id,
                userName: chatData.currentUser.name,
                timestamp: serverTimestamp()
            };

            const messagesRef = ref(database, `rooms/${chatData.currentRoom}/messages`);
            try {
                await push(messagesRef, message);
                messageInput.value = ''; 
            } catch (error) {
                console.error("Error sending message:", error);
                showCustomAlert(`Error sending message: ${error.message}`);
            }
        }

        function addMessageToDOM(message) {
            if (!messagesContainer || !chatData.currentUser) return;

            const messageDiv = document.createElement('div');
            messageDiv.classList.add('message');

            if (message.type === 'system') {
                messageDiv.className = 'system-message';
                messageDiv.textContent = escapeHtml(message.text);
            } else {
                const isOwn = message.userId === chatData.currentUser.id;
                messageDiv.classList.add(isOwn ? 'own' : 'other');
                
                const safeUserName = escapeHtml(message.userName || 'User');
                const safeMessageText = escapeHtml(message.text);
                const time = formatTime(message.timestamp);

                messageDiv.innerHTML = `
                    <div class="message-info">${safeUserName} • ${time}</div>
                    <div class="message-bubble">${safeMessageText}</div>
                `;
            }
            messagesContainer.appendChild(messageDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight; 
        }

        function listenForMessages() {
            if (!chatData.currentRoom || !database) return;
            chatData.messageListeners.forEach(unsubscribe => unsubscribe());
            chatData.messageListeners = [];

            const messagesQuery = ref(database, `rooms/${chatData.currentRoom}/messages`);
            const unsubscribe = onChildAdded(messagesQuery, (snapshot) => {
                const message = snapshot.val();
                if (message) { 
                    addMessageToDOM(message);
                }
            }, (error) => {
                console.error("Error listening for messages:", error);
                showCustomAlert("Error fetching messages. Please try refreshing.");
            });
            chatData.messageListeners.push(unsubscribe);
        }

        function updateOnlineCount() {
            if (!chatData.currentRoom || !database) return;
            const usersRef = ref(database, `rooms/${chatData.currentRoom}/users`);
            
            const unsubscribe = onValue(usersRef, (snapshot) => {
                const users = snapshot.val();
                const count = users ? Object.keys(users).length : 0;
                onlineCountEl.textContent = `${count} online`;
            }, (error) => {
                console.error("Error updating online count:", error);
            });
            chatData.messageListeners.push(unsubscribe);
        }

        async function leaveRoom() {
            if (!chatData.currentRoom || !chatData.currentUser || !database) return;
            
            const confirmed = await showCustomConfirm('Leave room? The room will be deleted if you are the last one.');
            if (!confirmed) return;

            addSystemMessage(`${chatData.currentUser.name} left the chat.`); 

            const roomUsersRef = ref(database, `rooms/${chatData.currentRoom}/users`);
            const currentUserInRoomRef = ref(database, `rooms/${chatData.currentRoom}/users/${chatData.currentUser.id}`);
            
            try {
                await remove(currentUserInRoomRef);
                const snapshot = await get(roomUsersRef);
                if (!snapshot.exists() || Object.keys(snapshot.val() || {}).length === 0) {
                    await remove(ref(database, `rooms/${chatData.currentRoom}`));
                    console.log(`Room ${chatData.currentRoom} deleted as it was empty.`);
                }
            } catch (error) {
                console.error("Error leaving room:", error);
                showCustomAlert(`Error leaving room: ${error.message}`);
            } finally {
                chatData.messageListeners.forEach(unsubscribe => unsubscribe());
                chatData.messageListeners = [];
                chatData.currentUser = null;
                chatData.currentRoom = null;

                chatContainer.style.display = 'none';
                welcomeScreen.style.display = 'flex'; // Changed from 'block' to 'flex'
                displayNameInput.value = '';
                roomCodeInput.value = '';
                messagesContainer.innerHTML = '<div class="system-message">Messages disappear when everyone leaves.</div>'; 
                displayNameInput.focus();
            }
        }

        async function shareRoom() {
            if (!chatData.currentRoom) return;
            const shareText = `Join my Shh Chat room! Code: ${chatData.currentRoom}\nOr use this link: ${window.location.href}`;
            try {
                if (navigator.clipboard && navigator.clipboard.writeText) {
                    await navigator.clipboard.writeText(shareText);
                    showCustomAlert('Room code and link copied to clipboard!');
                } else {
                    const textArea = document.createElement("textarea");
                    textArea.value = shareText;
                    document.body.appendChild(textArea);
                    textArea.focus();
                    textArea.select();
                    try {
                        document.execCommand('copy');
                        showCustomAlert('Room code and link copied to clipboard (fallback)!');
                    } catch (err) {
                        showCustomAlert('Failed to copy. Please copy manually:\n' + shareText);
                    }
                    document.body.removeChild(textArea);
                }
            } catch (err) {
                console.error('Could not copy text: ', err);
                showCustomAlert('Failed to copy room details. Please try again or copy manually.');
            }
        }

        // --- Event Listeners ---
        joinForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!database) { 
                showCustomAlert("Cannot join: Firebase is not connected.");
                return;
            }
            const displayName = displayNameInput.value.trim();
            const roomCode = roomCodeInput.value.trim().toUpperCase();

            if (!displayName) {
                showCustomAlert('Please enter your name.');
                return;
            }
            if (displayName.length > 25) { 
                showCustomAlert('Name must be 25 characters or less.');
                return;
            }
            if (roomCode && (roomCode.length < 4 || roomCode.length > 10)) { 
                 showCustomAlert('Room code must be between 4 and 10 characters if provided.');
                 return;
            }

            const originalBtnText = joinBtn.innerHTML;
            joinBtn.innerHTML = '<div class="loading"><div class="loading-dot"></div><div class="loading-dot"></div><div class="loading-dot"></div></div>';
            joinBtn.disabled = true;

            try {
                const result = await createOrJoinRoom(roomCode, displayName);
                if (result && result.roomCode) {
                    welcomeScreen.style.display = 'none';
                    chatContainer.style.display = 'flex';
                    roomTitle.textContent = `Room: ${result.roomCode}`;
                    messagesContainer.innerHTML = '<div class="system-message">Welcome! Messages disappear when everyone leaves.</div>'; 
                    
                    listenForMessages();
                    updateOnlineCount();
                    
                    messageInput.focus();
                }
            } catch (error) {
                console.error("Join form submission error:", error);
                showCustomAlert("An unexpected error occurred while joining the room.");
            } finally {
                joinBtn.innerHTML = originalBtnText;
                joinBtn.disabled = false;
            }
        });

        sendBtn.addEventListener('click', sendMessage);
        messageInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault(); 
                sendMessage();
            }
        });

        shareRoomBtn.addEventListener('click', shareRoom);
        leaveRoomBtn.addEventListener('click', leaveRoom);

        // Initial UI setup
        displayNameInput.focus();
        messagesContainer.innerHTML = '<div class="system-message">Messages disappear when everyone leaves.</div>';

        window.addEventListener('beforeunload', (event) => {
            if (chatData.currentRoom && chatData.currentUser) {
                event.preventDefault(); 
                event.returnValue = ''; 
            }
        });

    </script>
</body>
</html>
