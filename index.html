<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shh Chat</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="container">
        <!-- Sign-Up Form -->
        <div id="signUpForm" class="auth-form">
            <h2>Sign Up</h2>
            <form id="signUp">
                <input type="email" id="email" placeholder="Enter your email" required>
                <input type="password" id="password" placeholder="Enter your password" required>
                <button type="submit">Sign Up</button>
            </form>
            <p>Already have an account? <a href="javascript:void(0)" onclick="showSignInForm()">Sign In</a></p>
        </div>

        <!-- Sign-In Form -->
        <div id="signInForm" class="auth-form" style="display:none;">
            <h2>Sign In</h2>
            <form id="signIn">
                <input type="email" id="signInEmail" placeholder="Enter your email" required>
                <input type="password" id="signInPassword" placeholder="Enter your password" required>
                <button type="submit">Sign In</button>
            </form>
            <p>Don't have an account? <a href="javascript:void(0)" onclick="showSignUpForm()">Sign Up</a></p>
        </div>

        <!-- Chat Interface (Hidden by default) -->
        <div id="chatContainer" class="chat-container" style="display:none;">
            <div class="chat-header">
                <h3 id="roomTitle">Room</h3>
                <div class="online-count">
                    <span id="onlineCount">0 online</span>
                </div>
                <button onclick="leaveRoom()">Leave Room</button>
            </div>
            <div id="messagesContainer" class="messages-container">
                <div class="system-message">Messages disappear when everyone leaves.</div>
            </div>
            <div class="message-input-container">
                <input type="text" id="messageInput" placeholder="Message..." maxlength="500">
                <button onclick="sendMessage()">Send</button>
            </div>
        </div>
    </div>

    <!-- Firebase and custom script -->
    <script type="module">
        // Import Firebase modules
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/9.6.0/firebase-auth.js";
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.0/firebase-app.js";
        import { getDatabase, ref, set, push, get } from "https://www.gstatic.com/firebasejs/9.6.0/firebase-database.js";

        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBAXWKvlpwnzI9Lghj81d1_M1pIRbuM200",
            authDomain: "shh-chat-db9d0.firebaseapp.com",
            databaseURL: "https://shh-chat-db9d0-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "shh-chat-db9d0",
            storageBucket: "shh-chat-db9d0.firebasestorage.app",
            messagingSenderId: "20040883450",
            appId: "1:20040883450:web:833660405c634b2aaffd43",
            measurementId: "G-D7B8720EXN"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const database = getDatabase(app);

        // In-memory state for chat data
        const chatData = {
            currentUser: null,
            currentRoom: null
        };

        // Show sign-up form
        function showSignUpForm() {
            document.getElementById("signUpForm").style.display = "block";
            document.getElementById("signInForm").style.display = "none";
        }

        // Show sign-in form
        function showSignInForm() {
            document.getElementById("signUpForm").style.display = "none";
            document.getElementById("signInForm").style.display = "block";
        }

        // Handle sign-up
        document.getElementById("signUp").addEventListener("submit", function (e) {
            e.preventDefault();
            const email = document.getElementById("email").value;
            const password = document.getElementById("password").value;

            createUserWithEmailAndPassword(auth, email, password)
                .then((userCredential) => {
                    const user = userCredential.user;
                    console.log("User signed up:", user.uid);
                    showChatInterface();
                })
                .catch((error) => {
                    console.error("Error signing up:", error.message);
                });
        });

        // Handle sign-in
        document.getElementById("signIn").addEventListener("submit", function (e) {
            e.preventDefault();
            const email = document.getElementById("signInEmail").value;
            const password = document.getElementById("signInPassword").value;

            signInWithEmailAndPassword(auth, email, password)
                .then((userCredential) => {
                    const user = userCredential.user;
                    console.log("User signed in:", user.uid);
                    showChatInterface();
                })
                .catch((error) => {
                    console.error("Error signing in:", error.message);
                });
        });

        // Show chat interface after sign-up/sign-in
        function showChatInterface() {
            document.getElementById("signUpForm").style.display = "none";
            document.getElementById("signInForm").style.display = "none";
            document.getElementById("chatContainer").style.display = "block";
        }

        // Chat operations
        function sendMessage() {
            const messageInput = document.getElementById("messageInput");
            const text = messageInput.value.trim();
            if (!text || !chatData.currentUser || !chatData.currentRoom) return;

            const message = {
                id: Math.random().toString(36).substring(2, 15),
                type: "user",
                text: text,
                userId: chatData.currentUser.id,
                userName: chatData.currentUser.name,
                timestamp: Date.now(),
            };

            const messagesRef = ref(database, "rooms/" + chatData.currentRoom + "/messages");
            push(messagesRef, message);
            messageInput.value = "";
        }

        function leaveRoom() {
            if (confirm("Leave room? It will be deleted if empty.")) {
                // Your logic for leaving room
                showSignUpForm();
            }
        }
    </script>
</body>
</html>
