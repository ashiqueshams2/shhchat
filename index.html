<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simple Chat App - Modern</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji';
            background: linear-gradient(135deg, #6a82fb 0%, #fc5c7d 100%); /* New Gradient */
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            color: #333;
            overflow: hidden; 
        }

        /* Login Screen Styles */
        .login-screen {
            background: white;
            padding: 35px 40px; /* Increased padding */
            border-radius: 24px; /* More pronounced rounding */
            box-shadow: 0 20px 50px rgba(0,0,0,0.2);
            text-align: center;
            width: 90%;
            max-width: 400px; /* Slightly wider */
            display: flex; 
            flex-direction: column;
            align-items: center;
        }

        .login-screen h1 {
            font-size: 2em;
            margin-bottom: 15px;
            color: #333; /* Darker for modern feel */
            font-weight: 600;
        }
        .login-screen h1 .emoji { /* Style for emoji if needed */
             margin-right: 8px;
        }

        .login-screen p.instructions {
            margin-bottom: 30px; /* More space */
            color: #555;
            font-size: 0.95em;
            line-height: 1.6;
        }

        .login-input {
            width: 100%;
            padding: 15px 20px;
            margin-bottom: 20px;
            border: 1px solid #ddd; /* Softer border */
            border-radius: 12px;
            font-size: 15px;
            outline: none;
            transition: border-color 0.3s ease, box-shadow 0.3s ease;
            box-sizing: border-box;
        }

        .login-input:focus {
            border-color: #6a82fb; /* Match new gradient */
            box-shadow: 0 0 0 4px rgba(106, 130, 251, 0.15);
        }

        .login-button {
            background: linear-gradient(135deg, #6a82fb 0%, #fc5c7d 100%);
            color: white;
            border: none;
            padding: 15px 20px;
            border-radius: 12px;
            font-size: 1em; /* Relative font size */
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            width: 100%;
            margin-top: 10px;
            box-sizing: border-box;
            box-shadow: 0 5px 15px rgba(0,0,0,0.15);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px; /* Space between icon and text */
        }

        .login-button:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(106, 130, 251, 0.3);
        }

        #generatedCodeDisplay {
            margin-top: 25px;
            font-size: 1em;
            color: #28a745; /* Bootstrap success green */
            font-weight: 500;
            padding: 12px;
            background-color: #e9f7ef; /* Lighter green */
            border-radius: 10px;
            border: 1px solid #c3e6cb; /* Softer green border */
            line-height: 1.4;
            width: 100%; 
            word-wrap: break-word; 
        }
        #generatedCodeDisplay:empty {
            display: none;
        }

        /* Chat Screen Styles */
        .chat-screen {
            display: none; 
            width: 100vw;   
            height: 100vh;  
            position: fixed; 
            top: 0;
            left: 0;
            background: #f4f7f6; /* Light neutral background for chat area */
        }

        .chat-container {
            width: 100%;    
            height: 100%;   
            border-radius: 0; 
            box-shadow: none;   
            display: flex;
            flex-direction: column;
            overflow: hidden;
            background: #fff; /* Main chat container background */
        }

        .chat-header {
            background: #fff; /* Cleaner white header */
            color: #333; /* Dark text on white */
            padding: 15px 20px;
            text-align: left; /* Align header content left */
            position: relative; 
            flex-shrink: 0; 
            border-bottom: 1px solid #eee; /* Subtle separator */
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .chat-header-info {
            display: flex;
            flex-direction: column;
            gap: 2px; /* Small gap between info lines */
        }

        .chat-header-title {
            font-size: 1.1em; 
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px; /* Space between icon and title */
        }
        
        .chat-details {
            font-size: 0.75em; 
            color: #777;
            display: flex;
            flex-direction: column; /* Stack details vertically */
            gap: 1px;
        }
        .chat-participants-list {
            display: flex;
            align-items: center;
            gap: 4px;
        }
        .chat-participants-list .participant-icon {
            font-size: 0.9em;
        }


        .status-indicator-container {
            display: flex;
            align-items: center;
            font-size: 0.75em;
            color: #555;
        }
        .status-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background-color: #4ade80; /* Green for online */
            margin-right: 6px;
        }
        
        .chat-header-actions {
            display: flex;
            align-items: center;
        }

        .icon-button { /* Common style for icon buttons */
            background: transparent;
            border: none;
            color: #555; /* Icon color */
            font-size: 1.4em; /* Icon size */
            cursor: pointer;
            padding: 8px;
            border-radius: 50%;
            transition: background-color 0.2s ease, color 0.2s ease;
        }
        .icon-button:hover {
            background-color: #f0f0f0; /* Subtle hover background */
            color: #333;
        }
        .end-chat-btn-icon {
             color: #fc5c7d; /* Match gradient for end chat */
        }
        .end-chat-btn-icon:hover {
             background-color: #fce8ec;
             color: #d94462;
        }


        .messages {
            flex-grow: 1; 
            padding: 15px; 
            overflow-y: auto;
            background: #f4f7f6; /* Light neutral background */
        }

        .message {
            margin-bottom: 15px; 
            animation: slideIn 0.3s cubic-bezier(0.25, 0.1, 0.25, 1); /* Smoother animation */
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(10px); 
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .message.sent {
            display: flex; /* Use flex for alignment */
            flex-direction: column;
            align-items: flex-end;
        }

        .message.received { 
            display: flex; /* Use flex for alignment */
            flex-direction: column;
            align-items: flex-start;
        }
        
        .message-sender-name {
            font-size: 0.75em; 
            color: #555;   
            margin-bottom: 4px;
            padding: 0 2px; 
        }

        .message-bubble {
            display: inline-block;
            max-width: 78%; 
            padding: 10px 14px; 
            border-radius: 18px; 
            word-wrap: break-word;
            text-align: left; 
            box-shadow: 0 2px 4px rgba(0,0,0,0.05); /* Subtle shadow on bubbles */
        }

        .message.sent .message-bubble {
            background: linear-gradient(135deg, #6a82fb 0%, #7d8ef9 100%); /* Adjusted sent bubble gradient */
            color: white;
            border-bottom-right-radius: 6px; /* "Tail" effect */
        }

        .message.received .message-bubble {
            background: #e9ecef; 
            color: #212529; 
            border-bottom-left-radius: 6px; /* "Tail" effect */
        }

        .message-media {
            max-width: 100%;
            border-radius: 12px; 
            margin-top: 8px;
            display: block; 
        }

        .message-media img,
        .message-media video {
            max-width: 280px; 
            max-height: 280px; 
            border-radius: 10px;
            display: block; 
        }

        .input-area {
            padding: 12px 15px; 
            background: white;
            border-top: 1px solid #e0e0e0;
            flex-shrink: 0; 
        }

        .input-container {
            display: flex;
            gap: 10px; 
            align-items: flex-end; 
        }

        .message-input {
            flex: 1;
            border: 1px solid #ccc; /* Simpler border */
            border-radius: 22px; 
            padding: 12px 18px;
            resize: none;
            outline: none;
            font-family: inherit;
            font-size: 1em; /* Base font size */
            min-height: 44px; 
            max-height: 120px;
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
            line-height: 1.5;
        }

        .message-input:focus {
            border-color: #6a82fb;
            box-shadow: 0 0 0 3px rgba(106, 130, 251, 0.1);
        }
        
        /* Send and File buttons inherit .icon-button and add specific gradient */
        .send-btn, .file-btn {
            background: linear-gradient(135deg, #6a82fb 0%, #fc5c7d 100%);
            color: white;
            font-size: 1.2em; /* Icon size inside button */
            width: 44px;  
            height: 44px; 
            padding: 0; /* Reset padding as size is fixed */
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%; /* Circular */
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
        }
        .send-btn:hover, .file-btn:hover {
            background: linear-gradient(135deg, #5c75e6 0%, #e74f6f 100%); /* Darker on hover */
            transform: translateY(-1px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.15);
            color: white; /* Ensure icon color remains white */
        }
        .file-btn { font-size: 1.1em; } 

        .file-input {
            display: none;
        }

        .connection-info {
            text-align: center;
            padding: 15px;
            color: #555;
            font-size: 0.9em;
            font-style: italic;
            background-color: #f8f9fa; 
            border-radius: 10px;
            margin: 10px 15px; /* Margin for better spacing in messages area */
        }
    </style>
</head>
<body>

    <div class="login-screen" id="loginScreen">
        <h1><span class="emoji">👋</span>Welcome</h1>
        <p class="instructions">Enter your name and a chat code to join, or leave blank to create a new one.</p>
        <input type="text" id="userNameInput" class="login-input" placeholder="Your Name">
        <input type="text" id="chatCodeInput" class="login-input" placeholder="Chat Code (optional)">
        <button id="startJoinButton" class="login-button">➔ Start / Join</button>
        <div id="generatedCodeDisplay"></div>
    </div>

    <div class="chat-screen" id="chatScreen">
        <div class="chat-container">
            <div class="chat-header">
                <div class="chat-header-info">
                    <div class="chat-header-title">💬 <span id="chatTitleText">Chat Active</span></div>
                    <div class="chat-details">
                        <div id="participantDisplay" class="chat-participants-list">
                            <span class="participant-icon">👥</span> With: <span id="participantList"></span>
                        </div>
                        <div>Code: <strong id="displayChatCode"></strong></div>
                        <div class="status-indicator-container">
                            <span class="status-indicator"></span>
                            <span id="statusText">Online</span> </div>
                    </div>
                </div>
                <div class="chat-header-actions">
                    <button id="endChatButton" class="icon-button end-chat-btn-icon" title="End Chat">✕</button>
                </div>
            </div>
            
            <div class="messages" id="messagesContainer"> </div>
            
            <div class="input-area">
                <div class="input-container">
                    <textarea 
                        id="messageInput" 
                        class="message-input" 
                        placeholder="Type a message..."
                        rows="1"
                    ></textarea>
                    
                    <button class="file-btn icon-button" onclick="document.getElementById('fileInput').click()" title="Attach File">
                        📎
                    </button>
                    
                    <button class="send-btn icon-button" onclick="sendMessage()" title="Send Message">
                        ➤
                    </button>
                    
                    <input 
                        type="file" 
                        id="fileInput" 
                        class="file-input" 
                        accept="image/*,video/*"
                        onchange="handleFileSelect(event)"
                    >
                </div>
            </div>
        </div>
    </div>

    <script>
        class SimpleChatApp {
            constructor() {
                this.myNickname = null;
                this.chatCode = null;
                this.messagesStore = [];
                this.participants = [];
                this.isHost = false;
                this.socket = null;

                this.loginScreenEl = document.getElementById('loginScreen');
                this.chatScreenEl = document.getElementById('chatScreen');
                this.userNameInputEl = document.getElementById('userNameInput');
                this.chatCodeInputEl = document.getElementById('chatCodeInput');
                this.startJoinButtonEl = document.getElementById('startJoinButton');
                this.generatedCodeDisplayEl = document.getElementById('generatedCodeDisplay');

                this.chatTitleTextEl = document.getElementById('chatTitleText');
                this.participantListEl = document.getElementById('participantList');
                this.displayChatCodeEl = document.getElementById('displayChatCode');
                this.messagesContainerEl = document.getElementById('messagesContainer');
                this.messageInputEl = document.getElementById('messageInput');
                this.endChatButtonEl = document.getElementById('endChatButton');
                this.statusTextEl = document.getElementById('statusText'); // For "Online" text

                this.showLoginScreen();
                this.setupGlobalEventListeners();
            }

            generateUniqueCode() {
                return Math.random().toString(36).substring(2, 8).toUpperCase();
            }

            setupGlobalEventListeners() {
                this.startJoinButtonEl.addEventListener('click', () => this.handleStartJoin());
            }
            
            setupChatScreenEventListeners() {
                this.messageInputEl.addEventListener('keypress', this.handleMessageInputKeypress.bind(this));
                this.messageInputEl.addEventListener('input', () => this.autoResizeTextarea(this.messageInputEl));
                this.endChatButtonEl.onclick = () => this.handleEndChat();
            }

            autoResizeTextarea(textareaElement) {
                textareaElement.style.height = 'auto'; 
                let newHeight = Math.max(textareaElement.scrollHeight, parseFloat(getComputedStyle(textareaElement).minHeight));
                textareaElement.style.height = Math.min(newHeight, 120) + 'px'; 
            }

            updateParticipantDisplay() {
                if (this.participants.length > 0) {
                    this.participantListEl.textContent = this.participants.join(', ');
                    if (this.participants.length === 1 && this.isHost) {
                        // If only host is present, could show something like "Waiting for others..."
                        // For now, just show the host's name.
                    }
                } else {
                    this.participantListEl.textContent = 'No one yet';
                }
                this.chatTitleTextEl.textContent = `Chat (${this.participants.length})`;
            }


            showLoginScreen() {
                document.body.style.alignItems = 'center';
                this.loginScreenEl.style.display = 'flex'; 
                this.chatScreenEl.style.display = 'none';
                
                this.userNameInputEl.value = '';
                this.chatCodeInputEl.value = '';
                this.generatedCodeDisplayEl.textContent = '';
                this.messagesStore = [];
                this.participants = [];
                if (this.messagesContainerEl) this.messagesContainerEl.innerHTML = '';
                this.myNickname = null;
                this.chatCode = null;
                this.isHost = false;

                if (this.socket) {
                    this.socket.close();
                    this.socket = null;
                }
            }

            showChatScreen() {
                this.loginScreenEl.style.display = 'none';
                this.chatScreenEl.style.display = 'block'; 

                this.displayChatCodeEl.textContent = this.chatCode;
                this.statusTextEl.textContent = 'Online'; // Assuming online when chat screen is shown

                this.updateParticipantDisplay();


                this.messagesContainerEl.innerHTML = ''; 

                const initialMessageDiv = document.createElement('div');
                initialMessageDiv.className = 'connection-info';
                if (this.isHost) {
                    initialMessageDiv.innerHTML = `<p>✨ You've created chat <strong>${this.chatCode}</strong>! Share the code to invite others.</p>`;
                } else {
                    initialMessageDiv.innerHTML = `<p>🎉 Joined chat <strong>${this.chatCode}</strong>. Say hello!</p>`;
                }
                this.messagesContainerEl.appendChild(initialMessageDiv);
                
                this.messageInputEl.value = '';
                this.autoResizeTextarea(this.messageInputEl);

                this.setupChatScreenEventListeners();
                this.messageInputEl.focus(); 
            }

            handleMessageInputKeypress(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    this.sendMessageInternal();
                }
            }

            handleStartJoin() {
                const nickname = this.userNameInputEl.value.trim();
                const codeToJoin = this.chatCodeInputEl.value.trim().toUpperCase();

                if (!nickname) {
                    alert('Please enter your Name.');
                    return;
                }
                this.myNickname = nickname;
                this.participants = [this.myNickname]; // Add self to participants

                if (!codeToJoin) { 
                    this.isHost = true;
                    this.chatCode = this.generateUniqueCode();
                    this.generatedCodeDisplayEl.textContent = `Your New Chat Code: ${this.chatCode}`; 
                    this.participants.push("Waiting for friend..."); // Simulated second participant for host
                } else { 
                    this.isHost = false;
                    this.chatCode = codeToJoin;
                    this.generatedCodeDisplayEl.textContent = ''; 
                    this.participants.push("Chat Host"); // Simulate the host as another participant
                }
                // Ensure own name isn't duplicated if "Chat Host" is the same as myNickname (not an issue with this logic)
                // For better simulation, if joining, the "Chat Host" would be a different name.
                // Let's refine the participant simulation slightly
                if (this.isHost) {
                    // this.participants = [this.myNickname, "(Waiting...)"]; // Placeholder
                } else {
                    // When joining, it's you and the host (simulated)
                    // this.participants = [this.myNickname, "Friend (Host)"]; // More explicit simulation
                }


                this.showChatScreen();
            }

            sendMessageInternal() { 
                if (this.chatScreenEl.style.display === 'none') return;
                const text = this.messageInputEl.value.trim();
                if (!text) return;

                this.addMessageToChat(text, 'text', true, this.myNickname);

                this.messageInputEl.value = '';
                this.autoResizeTextarea(this.messageInputEl);
            }

            handleFileSelectInternal(event) { 
                if (this.chatScreenEl.style.display === 'none') return;
                const file = event.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (e) => {
                    const fileType = file.type.startsWith('image/') ? 'image' : (file.type.startsWith('video/') ? 'video' : 'other');
                    
                    if (fileType === 'other') {
                        this.addMessageToChat(`Shared file: ${file.name} (type: ${file.type})`, 'text', true, this.myNickname);
                    } else {
                         this.addMessageToChat(e.target.result, fileType, true, this.myNickname);
                    }
                };
                reader.readAsDataURL(file); 
                event.target.value = '';
            }
            
            addMessageToChat(content, type, isSent, senderName) { 
                const firstMessage = this.messagesStore.length === 0 && this.messagesContainerEl.querySelector('.connection-info');
                if (firstMessage) {
                    this.messagesContainerEl.innerHTML = '';
                }

                const messageDiv = document.createElement('div');
                messageDiv.className = `message ${isSent ? 'sent' : 'received'}`;

                if (senderName) { 
                    const senderNameDiv = document.createElement('div');
                    senderNameDiv.className = 'message-sender-name';
                    senderNameDiv.textContent = senderName;
                    messageDiv.appendChild(senderNameDiv); 
                }

                const bubbleDiv = document.createElement('div');
                bubbleDiv.className = 'message-bubble';

                if (type === 'text') {
                    bubbleDiv.textContent = content;
                } else if (type === 'image') {
                    const img = document.createElement('img');
                    img.src = content;
                    img.alt = "Sent image";
                    img.className = 'message-media';
                    bubbleDiv.appendChild(img);
                } else if (type === 'video') {
                    const video = document.createElement('video');
                    video.src = content;
                    video.controls = true;
                    video.className = 'message-media';
                    bubbleDiv.appendChild(video);
                }
                
                messageDiv.appendChild(bubbleDiv);
                this.messagesContainerEl.appendChild(messageDiv);
                requestAnimationFrame(() => {
                    this.messagesContainerEl.scrollTop = this.messagesContainerEl.scrollHeight;
                });

                this.messagesStore.push({
                    content,
                    type,
                    isSent,
                    sender: senderName || (isSent ? this.myNickname : 'System'), 
                    timestamp: Date.now()
                });
            }

            handleEndChat() {
                this.showLoginScreen();
            }
        }

        let chatApp;
        document.addEventListener('DOMContentLoaded', () => {
            chatApp = new SimpleChatApp();
        });

        function sendMessage() {
            if (chatApp) chatApp.sendMessageInternal();
        }

        function handleFileSelect(event) {
            if (chatApp) chatApp.handleFileSelectInternal(event);
        }
    </script>
</body>
</html>
