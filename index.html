<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>shhh chat 🤫</title>
    <link rel="apple-touch-icon" href="https://gomediashark.com/wp-content/uploads/2024/05/shushing-face.png">
    <link rel="icon" type="image/png" href="https://gomediashark.com/wp-content/uploads/2024/05/shushing-face.png">
    <meta name="theme-color" content="#007bff">

    <style>
        :root {
            --bg-page: #f0f2f5;
            --bg-container: #ffffff;
            --bg-header: #ffffff;
            --bg-messages: #f0f2f5;
            --bg-input-area: #ffffff;
            --bg-bubble-sent: linear-gradient(135deg, #0088cc, #006699);
            --bg-bubble-received: #e9ebee;
            --bg-button-hover: #f0f0f0;
            --bg-reply-bar: #f7f7f7;
            --bg-emoji-picker: #ffffff;

            --text-primary: #050505;
            --text-secondary: #65676b;
            --text-tertiary: #8a8d91;
            --text-on-accent: #ffffff;

            --border-primary: #ced0d4;
            --border-secondary: #e0e0e0;
            --border-reply: #dce0e4;
            --shadow-primary: rgba(0, 0, 0, 0.08);
            
            --accent-primary: #007bff;
            --online-indicator: #31a24c;
        }

        .dark-mode {
            --bg-page: #18191a;
            --bg-container: #242526;
            --bg-header: #242526;
            --bg-messages: #18191a;
            --bg-input-area: #242526;
            --bg-bubble-sent: linear-gradient(135deg, #4b88da, #3a6ab2);
            --bg-bubble-received: #3a3b3c;
            --bg-button-hover: #4a4a4c;
            --bg-reply-bar: #2e2f30;
            --bg-emoji-picker: #2d2d2d;

            --text-primary: #e4e6eb;
            --text-secondary: #b0b3b8;
            --text-tertiary: #8a8d91;
            
            --border-primary: #3a3b3c;
            --border-secondary: #303132;
            --border-reply: #3e4042;
            --shadow-primary: rgba(0, 0, 0, 0.4);
            
            --accent-primary: #4b88da;
            --online-indicator: #24a141;
        }
        
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html { height: calc(var(--vh, 1vh) * 100); }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; background: var(--bg-page); height: 100%; display: flex; justify-content: center; align-items: center; color: var(--text-primary); overflow: hidden; transition: background-color 0.3s ease; }
        
        .login-screen { background: var(--bg-container); padding: 35px 40px; border-radius: 24px; box-shadow: 0 20px 50px var(--shadow-primary); text-align: center; width: 90%; max-width: 400px; display: flex; flex-direction: column; align-items: center; transition: background-color 0.3s ease; }
        .login-screen h1 { font-size: 2.2em; margin-bottom: 15px; font-weight: 600; }
        .login-screen p.instructions { margin-bottom: 30px; color: var(--text-secondary); font-size: 0.95em; line-height: 1.6; }
        .login-input { width: 100%; padding: 15px 20px; margin-bottom: 20px; border: 1px solid var(--border-primary); background-color: var(--bg-page); color: var(--text-primary); border-radius: 12px; font-size: 15px; outline: none; transition: all 0.3s ease; }
        .login-input:focus { border-color: var(--accent-primary); box-shadow: 0 0 0 4px color-mix(in srgb, var(--accent-primary) 15%, transparent); }
        .login-button { background: var(--accent-primary); color: var(--text-on-accent); border: none; padding: 15px 20px; border-radius: 12px; font-size: 1em; font-weight: 600; cursor: pointer; transition: all 0.2s ease; width: 100%; margin-top: 10px; box-shadow: 0 5px 15px color-mix(in srgb, var(--accent-primary) 20%, transparent); display: flex; align-items: center; justify-content: center; gap: 8px; }
        .login-button:hover { transform: translateY(-2px); box-shadow: 0 8px 25px color-mix(in srgb, var(--accent-primary) 30%, transparent); }
        .login-button:disabled { background: var(--text-tertiary); cursor: not-allowed; transform: none; box-shadow: none; }

        .chat-screen { display: none; width: 100%; height: 100%; position: fixed; top: 0; left: 0; }
        .chat-container { width: 100%; height: 100%; display: flex; flex-direction: column; overflow: hidden; background: var(--bg-container); position: relative; }

        .chat-header { background: var(--bg-header); color: var(--text-primary); padding: 12px 20px; flex-shrink: 0; border-bottom: 1px solid var(--border-secondary); display: flex; justify-content: space-between; align-items: center; transition: background-color 0.3s ease, border-color 0.3s ease; position: sticky; top: 0; z-index: 2; }
        .chat-header-info h2 { font-size: 1.1em; font-weight: 600; margin-bottom: 5px;}
        .chat-details { display: flex; align-items: center; gap: 15px; font-size: 0.8em; color: var(--text-secondary); }
        .chat-code-display { background-color: var(--bg-page); padding: 2px 8px; border-radius: 6px; font-family: monospace; }
        .online-status-display { display: flex; align-items: center; gap: 6px; }
        .status-indicator { width: 8px; height: 8px; border-radius: 50%; background-color: var(--online-indicator); }
        .chat-header-actions { display: flex; align-items: center; gap: 8px; }
        .icon-button { background: transparent; border: none; color: var(--text-secondary); font-size: 1.4em; cursor: pointer; padding: 8px; border-radius: 50%; display: flex; align-items: center; justify-content: center; transition: background-color 0.2s ease; }
        .icon-button:hover { background-color: var(--bg-button-hover); }

        .messages { flex-grow: 1; padding: 15px; overflow-y: auto; background: var(--bg-messages); transition: background-color 0.3s ease; }
        .message { display: flex; flex-direction: column; margin-bottom: 2px; position: relative; }
        .message.sent { align-items: flex-end; }
        .message.received { align-items: flex-start; }
        .message:hover .message-actions { opacity: 1; }
        
        .sender-name { font-size: 0.8em; font-weight: 500; color: var(--text-secondary); margin-left: 15px; margin-bottom: 4px; }
        .message-content-wrapper { display: flex; align-items: flex-end; gap: 8px; max-width: 80%; }
        .message.sent .message-content-wrapper { flex-direction: row-reverse; }
        .message-bubble { padding: 10px 14px; border-radius: 18px; word-wrap: break-word; line-height: 1.5; box-shadow: 0 1px 2px var(--shadow-primary); color: var(--text-on-accent); }
        .message.sent .message-bubble { background: var(--bg-bubble-sent); border-bottom-right-radius: 6px; }
        .message.received .message-bubble { background: var(--bg-bubble-received); color: var(--text-primary); border-bottom-left-radius: 6px; }
        
        .message-quote { border-left: 3px solid var(--accent-primary); padding-left: 10px; margin-bottom: 8px; opacity: 0.8; font-size: 0.9em; }
        .message-quote .quote-author { font-weight: 600; }
        .message-quote .quote-text { white-space: pre-wrap; word-break: break-word; }

        .message-meta { display: flex; align-items: center; gap: 6px; margin: 2px 4px 4px 4px; }
        .message-timestamp { font-size: 0.7em; color: var(--text-tertiary); white-space: nowrap; }
        .read-receipt { font-size: 0.7em; color: var(--accent-primary); font-weight: 600; }
        
        .message-actions { position: absolute; top: 50%; transform: translateY(-50%); opacity: 0; transition: opacity 0.2s; }
        .message.sent .message-actions { right: 100%; margin-right: 5px; }
        .message.received .message-actions { left: 100%; margin-left: 5px; }
        .message-actions .icon-button { font-size: 1.1em; padding: 5px; }

        .system-message { text-align: center; color: var(--text-secondary); font-size: 0.85em; padding: 12px 0; font-style: italic; }

        .input-area { padding: 12px 15px; background: var(--bg-input-area); border-top: 1px solid var(--border-secondary); flex-shrink: 0; transition: background-color 0.3s ease, border-color 0.3s ease; position: sticky; bottom: 0; z-index: 2; }
        
        /* New: Reply Bar Styling */
        .reply-bar { display: none; padding: 8px 15px; background-color: var(--bg-reply-bar); border-bottom: 1px solid var(--border-reply); font-size: 0.9em; color: var(--text-secondary); }
        .reply-bar-content { display: flex; justify-content: space-between; align-items: center; }
        .reply-bar-text { overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .reply-bar-text strong { color: var(--text-primary); }
        .close-reply-btn { background: none; border: none; font-size: 1.5em; cursor: pointer; color: var(--text-secondary); padding: 0 5px;}

        /* New: Typing Indicator Styling */
        .typing-indicator { font-size: 0.8em; color: var(--text-secondary); height: 20px; padding: 0 15px 4px; font-style: italic; }

        .input-container { display: flex; gap: 10px; align-items: flex-end; }
        .message-input { flex: 1; border: 1px solid var(--border-primary); background: var(--bg-messages); color: var(--text-primary); border-radius: 22px; padding: 12px 18px; resize: none; outline: none; font-family: inherit; font-size: 1em; max-height: 120px; transition: all 0.2s ease; line-height: 1.5; }
        .message-input:focus { border-color: var(--accent-primary); box-shadow: 0 0 0 3px color-mix(in srgb, var(--accent-primary) 15%, transparent); }
        
        .input-buttons { display: flex; align-items: center; gap: 5px; position: relative; }
        .send-btn { background: var(--accent-primary); color: var(--text-on-accent); font-size: 1.2em; width: 46px; height: 46px; padding: 0; display: flex; align-items: center; justify-content: center; border-radius: 50%; box-shadow: 0 3px 10px var(--shadow-primary); border: none; cursor: pointer; transition: all 0.2s ease; flex-shrink: 0; }
        .send-btn:hover { transform: scale(1.05); box-shadow: 0 5px 15px color-mix(in srgb, var(--accent-primary) 25%, transparent); }
        .send-btn:disabled { background: var(--text-tertiary); cursor: not-allowed; transform: none; box-shadow: none; }
        
        /* New: Emoji Picker Styling */
        .emoji-picker { display: none; position: absolute; bottom: 55px; right: 0; background: var(--bg-emoji-picker); border: 1px solid var(--border-secondary); border-radius: 12px; box-shadow: 0 5px 15px var(--shadow-primary); width: 280px; height: 200px; padding: 10px; overflow-y: auto; z-index: 10; }
        .emoji-picker button { background: none; border: none; font-size: 1.5em; padding: 5px; border-radius: 8px; cursor: pointer; transition: background-color 0.2s; }
        .emoji-picker button:hover { background-color: var(--bg-button-hover); }

        .scroll-to-bottom-btn { position: absolute; bottom: 90px; right: 20px; width: 40px; height: 40px; background-color: var(--bg-container); color: var(--text-secondary); border: 1px solid var(--border-secondary); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.2em; cursor: pointer; box-shadow: 0 4px 10px var(--shadow-primary); opacity: 0; transform: translateY(20px); transition: opacity 0.3s ease, transform 0.3s ease, background-color 0.3s ease; visibility: hidden; }
        .scroll-to-bottom-btn.visible { opacity: 1; transform: translateY(0); visibility: visible; }
        .scroll-to-bottom-btn:hover { background-color: var(--bg-button-hover); }
    </style>
</head>
<body>

    <div class="login-screen" id="loginScreen">
        <h1>🤫 shhh chat</h1>
        <p class="instructions">Your private space to talk. Enter your name and a code to begin.</p>
        <input type="text" id="userNameInput" class="login-input" placeholder="Your Name" required>
        <input type="text" id="chatCodeInput" class="login-input" placeholder="Chat Code (or leave blank)">
        <button id="startJoinButton" class="login-button">➔ Enter</button>
    </div>

    <div class="chat-screen" id="chatScreen">
        <div class="chat-container">
            <div class="chat-header">
                <div class="chat-header-info">
                    <h2 id="chatHeaderTitle">Room</h2>
                    <div class="chat-details">
                        <span class="chat-code-display">Code: <strong id="displayChatCode"></strong></span>
                        <span class="online-status-display">
                            <span class="status-indicator"></span>
                            <span id="onlineCount">0</span>&nbsp;Online
                        </span>
                    </div>
                </div>
                <div class="chat-header-actions">
                    <button id="themeToggle" class="icon-button" aria-label="Toggle Theme" title="Toggle Theme">🌙</button>
                    <button id="endChatButton" class="icon-button" aria-label="End Chat" title="End Chat">✕</button>
                </div>
            </div>
            
            <div class="messages" id="messagesContainer"></div>
            <button id="scrollToBottomBtn" class="scroll-to-bottom-btn" aria-label="Scroll to Bottom" title="Scroll to Bottom">↓</button>
            
            <div class="input-area">
                <div class="reply-bar" id="replyBar">
                    <div class="reply-bar-content">
                        <div class="reply-bar-text" id="replyBarText"></div>
                        <button class="close-reply-btn" id="closeReplyBtn" aria-label="Cancel Reply">&times;</button>
                    </div>
                </div>

                <div class="typing-indicator" id="typingIndicator"></div>

                <div class="input-container">
                    <textarea id="messageInput" class="message-input" placeholder="Type a message..." rows="1"></textarea>
                    <div class="input-buttons">
                        <button class="icon-button" id="emojiBtn" aria-label="Open Emojis" title="Open Emojis">😀</button>
                        <div class="emoji-picker" id="emojiPicker"></div>
                        <button class="send-btn" id="sendBtn" aria-label="Send Message" title="Send Message">➤</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        // Firebase SDK imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js";
        import { 
            getDatabase, ref, set, push, get, 
            onChildAdded, onChildRemoved, onValue, 
            remove, update, serverTimestamp, query 
        } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-database.js";

        // --- Firebase Configuration ---
        const firebaseConfig = {
            apiKey: "AIzaSyBAXWKvlpwnzI9Lghj81d1_M1pIRbuM200",
            authDomain: "shh-chat-db9d0.firebaseapp.com",
            databaseURL: "https://shh-chat-db9d0-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "shh-chat-db9d0",
            storageBucket: "shh-chat-db9d0.appspot.com",
            messagingSenderId: "20040883450",
            appId: "1:20040883450:web:833660405c634b2aaffd43"
        };
        
        // --- DOM Element Declarations ---
        const loginScreen = document.getElementById('loginScreen');
        const chatScreen = document.getElementById('chatScreen');
        const userNameInput = document.getElementById('userNameInput');
        const chatCodeInput = document.getElementById('chatCodeInput');
        const startJoinButton = document.getElementById('startJoinButton');

        const chatHeaderTitle = document.getElementById('chatHeaderTitle');
        const displayChatCode = document.getElementById('displayChatCode');
        const onlineCount = document.getElementById('onlineCount');
        const themeToggle = document.getElementById('themeToggle');
        const endChatButton = document.getElementById('endChatButton');
        
        const messagesContainer = document.getElementById('messagesContainer');
        const scrollToBottomBtn = document.getElementById('scrollToBottomBtn');
        const messageInput = document.getElementById('messageInput');
        const sendBtn = document.getElementById('sendBtn');

        // New DOM elements for features
        const emojiBtn = document.getElementById('emojiBtn');
        const emojiPicker = document.getElementById('emojiPicker');
        const replyBar = document.getElementById('replyBar');
        const replyBarText = document.getElementById('replyBarText');
        const closeReplyBtn = document.getElementById('closeReplyBtn');
        const typingIndicator = document.getElementById('typingIndicator');
        
        // --- App State ---
        let app;
        let database;
        const chatData = {
            currentUser: null,
            currentRoom: null,
            messageListeners: [],
            replyTo: null, // New: To store reply context
            typingTimeout: null // New: For typing indicator
        };

        // --- Firebase Initialization ---
        try {
            app = initializeApp(firebaseConfig);
            database = getDatabase(app);
            console.log("Firebase initialized successfully.");
        } catch (error) {
            console.error("Firebase initialization error:", error);
            alert(`Firebase initialization error. Please check your configuration and the console. Error: ${error.message}`);
            startJoinButton.disabled = true;
            startJoinButton.textContent = 'Error';
        }

        // --- Utility Functions ---
        const generateId = () => Math.random().toString(36).substring(2, 9);
        const formatTime = (timestamp) => !timestamp ? '' : new Date(timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        const escapeHtml = (text) => {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        };
        const setViewportHeight = () => {
            const vh = window.innerHeight * 0.01;
            document.documentElement.style.setProperty('--vh', `${vh}px`);
        };

        // --- Core Chat Functions ---
        async function createOrJoinRoom(roomCode, userName) {
            if (!database) { alert("Database not initialized."); return null; }
            
            const userId = generateId();
            chatData.currentUser = { id: userId, name: userName };
            const effectiveRoomCode = roomCode || generateId().toUpperCase();

            const roomRef = ref(database, `rooms/${effectiveRoomCode}`);
            const userRef = ref(database, `rooms/${effectiveRoomCode}/users/${userId}`);
            const presenceRef = ref(database, `.info/connected`); // For presence
            const typingRef = ref(database, `rooms/${effectiveRoomCode}/typing/${userId}`); // For typing indicator

            try {
                const roomSnapshot = await get(roomRef);
                if (!roomSnapshot.exists()) {
                    await set(roomRef, { createdAt: serverTimestamp() });
                }
                
                // Set user data and handle disconnects
                await set(userRef, { name: userName, joinedAt: serverTimestamp() });
                onValue(presenceRef, async (snap) => {
                    if (snap.val() === true) {
                        await remove(userRef).catch(()=>{}); // Clean up on disconnect
                        await remove(typingRef).catch(()=>{}); // Clean up typing status on disconnect
                    }
                });

                chatData.currentRoom = effectiveRoomCode;
                await addSystemMessage(`${userName} joined the chat.`);
                return { roomCode: effectiveRoomCode };
            } catch (error) {
                console.error("Error creating/joining room:", error);
                alert(`Error joining room: ${error.message}`);
                return null;
            }
        }

        async function sendMessage() {
            if (!database) return;
            const text = messageInput.value.trim();
            if (!text || !chatData.currentUser || !chatData.currentRoom) return;

            const message = {
                text: text,
                userId: chatData.currentUser.id,
                userName: chatData.currentUser.name,
                timestamp: serverTimestamp(),
                seenBy: {} // New: For read receipts
            };
            
            // Add reply context if it exists
            if (chatData.replyTo) {
                message.replyTo = chatData.replyTo;
            }

            try {
                const messagesRef = ref(database, `rooms/${chatData.currentRoom}/messages`);
                await push(messagesRef, message);
                messageInput.value = '';
                messageInput.style.height = 'auto'; // Reset height
                cancelReply(); // Clear reply context
                updateTypingStatus(false); // User is no longer typing
            } catch (error) {
                console.error("Error sending message:", error);
                alert(`Error sending message: ${error.message}`);
            }
        }

        async function addSystemMessage(text) {
            if (!chatData.currentRoom || !database) return;
            const message = { type: 'system', text: text, timestamp: serverTimestamp() };
            try {
                const messagesRef = ref(database, `rooms/${chatData.currentRoom}/messages`);
                await push(messagesRef, message);
            } catch (error) {
                console.error("Error sending system message:", error);
            }
        }

        async function leaveRoom() {
            if (!chatData.currentRoom || !chatData.currentUser) return;

            const { id: leavingUserId, name: leavingUserName } = chatData.currentUser;
            const { currentRoom: currentRoomCode } = chatData;
            
            await addSystemMessage(`${leavingUserName} left the chat.`); 

            // Stop all listeners before removing data
            chatData.messageListeners.forEach(unsubscribe => unsubscribe());
            chatData.messageListeners = [];

            const userRef = ref(database, `rooms/${currentRoomCode}/users/${leavingUserId}`);
            const typingRef = ref(database, `rooms/${currentRoomCode}/typing/${leavingUserId}`);
            
            try {
                // Remove user and their typing status
                await remove(userRef);
                await remove(typingRef);
                
                // Check if room is empty to clean it up
                const roomUsersRef = ref(database, `rooms/${currentRoomCode}/users`);
                const usersSnapshot = await get(roomUsersRef);
                if (!usersSnapshot.exists()) {
                    await remove(ref(database, `rooms/${currentRoomCode}`));
                }
            } catch (error) {
                console.error("Error during leave room cleanup:", error);
            } finally {
                resetUI();
            }
        }

        function resetUI() {
            Object.assign(chatData, { currentUser: null, currentRoom: null, replyTo: null });
            
            chatScreen.style.display = 'none';
            loginScreen.style.display = 'flex';
            
            chatCodeInput.value = '';
            messagesContainer.innerHTML = '';
            userNameInput.focus();
            cancelReply();
        }

        // --- DOM Manipulation and Listeners ---
        function addMessageToDOM(message, messageId) {
            const wasScrolledToBottom = messagesContainer.scrollHeight - messagesContainer.clientHeight <= messagesContainer.scrollTop + 5;
            
            const div = document.createElement('div');
            div.dataset.messageId = messageId;

            if (message.type === 'system') {
                div.className = 'system-message';
                div.textContent = escapeHtml(message.text);
            } else {
                const isSent = message.userId === chatData.currentUser.id;
                div.className = `message ${isSent ? 'sent' : 'received'}`;
                
                let senderNameHTML = !isSent ? `<div class="sender-name">${escapeHtml(message.userName)}</div>` : '';
                
                // New: Render replied-to message quote
                let quoteHTML = '';
                if (message.replyTo) {
                    quoteHTML = `
                        <div class="message-quote">
                            <div class="quote-author">${escapeHtml(message.replyTo.userName)}</div>
                            <div class="quote-text">${escapeHtml(message.replyTo.text)}</div>
                        </div>
                    `;
                }
                
                // New: Show read receipt if message is sent and seen by others
                const hasBeenSeen = !isSent || (message.seenBy && Object.keys(message.seenBy).length > 0);
                const readReceiptHTML = isSent && hasBeenSeen ? `<span class="read-receipt">Seen</span>` : '';

                div.innerHTML = `
                    ${senderNameHTML}
                    <div class="message-content-wrapper">
                         <div class="message-bubble">
                            ${quoteHTML}
                            ${escapeHtml(message.text)}
                         </div>
                    </div>
                    <div class="message-meta">
                        <span class="message-timestamp">${formatTime(message.timestamp)}</span>
                        ${readReceiptHTML}
                    </div>
                    <div class="message-actions">
                        <button class="icon-button reply-btn" title="Reply">↩️</button>
                    </div>
                `;

                // New: Read Receipt Logic - mark as seen when it becomes visible
                if (!isSent) {
                    const observer = new IntersectionObserver((entries) => {
                        if (entries[0].isIntersecting) {
                            markMessageAsRead(messageId);
                            observer.disconnect(); // Only mark as read once
                        }
                    }, { threshold: 0.8 });
                    observer.observe(div);
                }
            }
            messagesContainer.appendChild(div);

            if (wasScrolledToBottom) {
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
            }
        }

        // New: Reply feature functions
        function startReply(messageElement) {
            const messageId = messageElement.dataset.messageId;
            const originalBubble = messageElement.querySelector('.message-bubble');
            const senderName = messageElement.querySelector('.sender-name')?.textContent || 'You';
            
            if (!messageId || !originalBubble) return;

            const originalText = originalBubble.textContent.trim();
            
            chatData.replyTo = {
                id: messageId,
                userName: senderName,
                text: originalText.substring(0, 50) + (originalText.length > 50 ? '...' : '')
            };

            replyBarText.innerHTML = `Replying to <strong>${escapeHtml(senderName)}</strong>: "${escapeHtml(chatData.replyTo.text)}"`;
            replyBar.style.display = 'block';
            messageInput.focus();
        }

        function cancelReply() {
            chatData.replyTo = null;
            replyBar.style.display = 'none';
        }
        
        // New: Read Receipt function
        async function markMessageAsRead(messageId) {
            if (!chatData.currentRoom || !chatData.currentUser) return;
            const messageSeenRef = ref(database, `rooms/${chatData.currentRoom}/messages/${messageId}/seenBy/${chatData.currentUser.id}`);
            try {
                await set(messageSeenRef, true);
            } catch (error) {
                console.error("Failed to mark message as read:", error);
            }
        }

        // New: Typing indicator functions
        function updateTypingStatus(isTyping) {
            const typingRef = ref(database, `rooms/${chatData.currentRoom}/typing/${chatData.currentUser.id}`);
            if (isTyping) {
                set(typingRef, chatData.currentUser.name);
            } else {
                remove(typingRef);
            }
        }

        function listenForTyping() {
            const typingQuery = ref(database, `rooms/${chatData.currentRoom}/typing`);
            const unsub = onValue(typingQuery, (snapshot) => {
                const typers = [];
                snapshot.forEach(childSnapshot => {
                    // Don't show our own typing status
                    if (childSnapshot.key !== chatData.currentUser.id) {
                        typers.push(escapeHtml(childSnapshot.val()));
                    }
                });

                if (typers.length === 0) {
                    typingIndicator.textContent = '';
                } else if (typers.length === 1) {
                    typingIndicator.textContent = `${typers[0]} is typing...`;
                } else {
                    typingIndicator.textContent = `${typers.join(', ')} are typing...`;
                }
            });
            chatData.messageListeners.push(unsub);
        }
        
        function listenForMessages() {
            const messagesQuery = query(ref(database, `rooms/${chatData.currentRoom}/messages`));
            
            const unsubAdded = onChildAdded(messagesQuery, (snapshot) => {
                addMessageToDOM(snapshot.val(), snapshot.key);
            });
            chatData.messageListeners.push(unsubAdded);

            const unsubRemoved = onChildRemoved(messagesQuery, (snapshot) => {
                const el = document.querySelector(`[data-message-id="${snapshot.key}"]`);
                if (el) el.remove();
            });
            chatData.messageListeners.push(unsubRemoved);
            
            // New: Listen for changes (e.g., read receipts)
            const unsubChanged = onValue(messagesQuery, (snapshot) => {
                 snapshot.forEach(childSnapshot => {
                     const message = childSnapshot.val();
                     const messageId = childSnapshot.key;
                     const el = document.querySelector(`[data-message-id="${messageId}"]`);
                     if (el && message.userId === chatData.currentUser.id) {
                         const receiptEl = el.querySelector('.read-receipt');
                         const hasBeenSeen = message.seenBy && Object.keys(message.seenBy).length > 0;
                         if (hasBeenSeen && !receiptEl) {
                             const metaEl = el.querySelector('.message-meta');
                             metaEl.innerHTML += `<span class="read-receipt">Seen</span>`;
                         }
                     }
                 });
            });
            chatData.messageListeners.push(unsubChanged);
        }

        function updateOnlineCount() {
            const usersRef = ref(database, `rooms/${chatData.currentRoom}/users`);
            const unsub = onValue(usersRef, (snapshot) => {
                onlineCount.textContent = snapshot.exists() ? Object.keys(snapshot.val()).length : 0;
            });
            chatData.messageListeners.push(unsub);
        }
        
        // New: Emoji Picker functions
        function populateEmojiPicker() {
            const emojis = ['😀', '😂', '😍', '🤔', '👍', '❤️', '🎉', '🔥', '💯', '🙏', '😢', '😠'];
            emojis.forEach(emoji => {
                const btn = document.createElement('button');
                btn.textContent = emoji;
                btn.onclick = () => {
                    messageInput.value += emoji;
                    messageInput.focus();
                };
                emojiPicker.appendChild(btn);
            });
        }
        
        function toggleEmojiPicker() {
            const isVisible = emojiPicker.style.display === 'block';
            emojiPicker.style.display = isVisible ? 'none' : 'block';
        }

        function handleJoinClick() {
            const userName = userNameInput.value.trim();
            const roomCode = chatCodeInput.value.trim().toUpperCase();
            if (!userName) { alert('Please enter your name.'); return; }
            
            startJoinButton.disabled = true;
            
            createOrJoinRoom(roomCode, userName).then(result => {
                if (result) {
                    loginScreen.style.display = 'none';
                    chatScreen.style.display = 'block';
                    chatHeaderTitle.textContent = `Room: ${result.roomCode}`;
                    displayChatCode.textContent = result.roomCode;
                    messageInput.focus();
                    
                    listenForMessages();
                    updateOnlineCount();
                    listenForTyping(); // New
                }
            }).finally(() => {
                startJoinButton.disabled = false;
            });
        }
        
        // --- Event Listeners Setup ---
        startJoinButton.addEventListener('click', handleJoinClick);
        userNameInput.addEventListener('keypress', (e) => e.key === 'Enter' && chatCodeInput.focus());
        chatCodeInput.addEventListener('keypress', (e) => e.key === 'Enter' && handleJoinClick());
        
        sendBtn.addEventListener('click', sendMessage);
        messageInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });
        messageInput.addEventListener('input', () => {
            messageInput.style.height = 'auto';
            messageInput.style.height = `${messageInput.scrollHeight}px`;
            
            // Typing indicator logic
            if (chatData.typingTimeout) clearTimeout(chatData.typingTimeout);
            updateTypingStatus(true);
            chatData.typingTimeout = setTimeout(() => {
                updateTypingStatus(false);
            }, 2000); // Consider user stopped typing after 2 seconds
        });
        
        endChatButton.addEventListener('click', () => {
            if (confirm('Are you sure you want to leave the chat?')) {
                leaveRoom();
            }
        });
        
        // New event listeners for features
        emojiBtn.addEventListener('click', toggleEmojiPicker);
        closeReplyBtn.addEventListener('click', cancelReply);
        messagesContainer.addEventListener('click', (e) => {
            const replyButton = e.target.closest('.reply-btn');
            if (replyButton) {
                const messageElement = e.target.closest('.message');
                startReply(messageElement);
            }
        });

        messagesContainer.addEventListener('scroll', () => {
            const isScrolledUp = messagesContainer.scrollHeight - messagesContainer.clientHeight - messagesContainer.scrollTop > 150;
            scrollToBottomBtn.classList.toggle('visible', isScrolledUp);
        });
        scrollToBottomBtn.addEventListener('click', () => {
            messagesContainer.scrollTo({ top: messagesContainer.scrollHeight, behavior: 'smooth' });
        });
        
        themeToggle.addEventListener('click', () => {
            const isDark = document.body.classList.toggle('dark-mode');
            themeToggle.textContent = isDark ? '☀️' : '🌙';
            localStorage.setItem('shhh-theme', isDark ? 'dark' : 'light');
        });
        
        window.addEventListener('resize', setViewportHeight);
        window.addEventListener('beforeunload', () => {
             // Try to clean up user data if they close the tab
             if (chatData.currentUser && chatData.currentRoom) {
                 const userRef = ref(database, `rooms/${chatData.currentRoom}/users/${chatData.currentUser.id}`);
                 const typingRef = ref(database, `rooms/${chatData.currentRoom}/typing/${chatData.currentUser.id}`);
                 remove(userRef);
                 remove(typingRef);
             }
        });

        // --- Initial Load ---
        (function init() {
            setViewportHeight();
            const savedTheme = localStorage.getItem('shhh-theme');
            if (savedTheme === 'dark') {
                document.body.classList.add('dark-mode');
                themeToggle.textContent = '☀️';
            }
            populateEmojiPicker(); // New
            userNameInput.focus();
        })();

    </script>
</body>
</html>
